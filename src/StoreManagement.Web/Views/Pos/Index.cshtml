@model StoreManagement.Web.Models.PosViewModel
@{
    ViewData["Title"] = "Bán hàng POS";
}
<style>
    .product-card { cursor: pointer; transition: 0.2s; border: 1px solid #e9ecef; }
    .product-card:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15); border-color: #0d6efd; }
    .scrollable-list { height: calc(100vh - 180px); overflow-y: auto; }
    .cart-list { height: calc(100vh - 350px); overflow-y: auto; }
</style>

<div class="row h-100 g-3">
    <!-- Product List (Smaller Width: col-md-7) -->
    <div class="col-md-7">
        <div class="card shadow-sm h-100 border-0">
            <div class="card-header bg-white py-3 border-bottom">
                <div class="row g-2">
                    <div class="col-8">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="searchProduct" class="form-control border-start-0" placeholder="Tìm sản phẩm..." />
                        </div>
                    </div>
                    <div class="col-4">
                        <select id="categoryFilter" class="form-select">
                            <option value="all">Tất cả</option>
                            @foreach(var cat in Model.Categories) {
                                <option value="@cat.CategoryId">@cat.CategoryName</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body bg-light scrollable-list p-3">
                <!-- Enforce 3 columns per row for products -->
                <div class="row row-cols-3 g-3" id="productList">
                    @foreach(var item in Model.Products)
                    {
                        <div class="col product-item" data-name="@item.ProductName" data-cat="@item.CategoryId">
                            <div class="card product-card h-100 bg-white" onclick="addToCart(@item.ProductId, '@item.ProductName', @item.Price)">
                                <div class="card-body text-center p-2 d-flex flex-column justify-content-center">
                                    <div class="mb-2 text-primary display-6"><i class="fas fa-box"></i></div>
                                    <h6 class="card-title text-truncate w-100 mb-1" title="@item.ProductName">@item.ProductName</h6>
                                    <p class="card-text text-danger fw-bold m-0">@item.Price.ToString("N0")</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Cart (Larger Width: col-md-5) -->
    <div class="col-md-5">
        <div class="card shadow-sm h-100 border-0">
            <div class="card-header bg-primary text-white py-3">
                <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Giỏ hàng</h5>
            </div>
            <div class="card-body d-flex flex-column p-0">
                <div class="p-3 bg-white border-bottom">
                    <label class="small text-muted mb-1">Khách hàng</label>
                    <div class="input-group">
                         <span class="input-group-text bg-white"><i class="fas fa-user text-primary"></i></span>
                         <!-- Use a datalist or select2 in real implementation, for now simple select -->
                        <select id="customerSelect" class="form-select">
                            <option value="">-- Khách lẻ (Vãng lai) --</option>
                            @foreach(var cus in Model.Customers) {
                                <option value="@cus.CustomerId">@cus.Name - @cus.Phone</option>
                            }
                        </select>
                         <button class="btn btn-outline-secondary" title="Thêm khách mới"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                
                <!-- Cart Items Header -->
                <div class="px-3 py-2 bg-light border-bottom fw-bold d-flex text-muted small">
                    <div style="width: 45%">Sản phẩm</div>
                    <div style="width: 25%" class="text-center">SL</div>
                    <div style="width: 25%" class="text-end">Thành tiền</div>
                    <div style="width: 5%"></div>
                </div>

                <!-- Scrollable Cart Items -->
                <div class="flex-grow-1 cart-list bg-white" id="cartContainer">
                   <table class="table table-hover mb-0">
                        <tbody id="cartTable">
                            <!-- Items go here -->
                        </tbody>
                   </table>
                </div>

                <!-- Footer -->
                <div class="p-3 bg-light border-top">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Tổng số lượng:</span>
                        <span id="totalItems" class="fw-bold">0</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="h5 mb-0">Tổng thanh toán:</span>
                        <span id="totalAmount" class="h3 text-danger fw-bold m-0">0 ₫</span>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="fas fa-credit-card me-2"></i>Phương thức thanh toán</label>
                        <select id="paymentMethod" class="form-select">
                            <option value="cash" selected>Tiền mặt</option>
                            <option value="transfer">Chuyển khoản</option>
                            <option value="card">Thẻ tín dụng / Ghi nợ</option>
                        </select>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                             <button class="btn btn-outline-danger w-100 py-2" onclick="clearCart()">
                                 <i class="fas fa-trash-alt me-2"></i>Hủy
                             </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-success w-100 py-2 fw-bold shadow-sm" onclick="checkout()">
                                <i class="fas fa-money-bill-wave me-2"></i>THANH TOÁN
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let cart = {};

        function addToCart(id, name, price) {
            if (cart[id]) {
                cart[id].qty++;
            } else {
                cart[id] = { name: name, price: price, qty: 1 };
            }
            renderCart();
            // Toast notification
            const Toast = Swal.mixin({
              toast: true,
              position: 'bottom-start',
              showConfirmButton: false,
              timer: 1500,
              timerProgressBar: false
            });
            Toast.fire({ icon: 'success', title: 'Đã thêm ' + name });
        }

        function removeFromCart(id) {
            delete cart[id];
            renderCart();
        }
        
        function clearCart() {
             if ($.isEmptyObject(cart)) return;
             Swal.fire({
                title: 'Xóa giỏ hàng?',
                text: "Bạn có chắc chắn muốn xóa toàn bộ giỏ hàng?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Không'
            }).then((result) => {
                if (result.isConfirmed) {
                    cart = {};
                    renderCart();
                }
            });
        }

        function updateQty(id, delta) {
            if (cart[id]) {
                cart[id].qty += delta;
                if (cart[id].qty <= 0) delete cart[id];
            }
            renderCart();
        }
        
        function onQtyChange(id, el) {
            let newQty = parseInt($(el).val());
            if(isNaN(newQty) || newQty < 1) newQty = 1;
            if(cart[id]) {
                cart[id].qty = newQty;
                renderCart();
            }
        }

        function renderCart() {
            let tbody = $('#cartTable');
            tbody.empty();
            let total = 0;
            let count = 0;
            
            if ($.isEmptyObject(cart)) {
                tbody.html('<tr><td colspan="4" class="text-center text-muted py-5"><i class="fas fa-shopping-basket fa-3x mb-3 opacity-25"></i><br>Giỏ hàng trống</td></tr>');
                $('#totalAmount').text('0 ₫');
                $('#totalItems').text('0');
                return;
            }

            for (let id in cart) {
                let item = cart[id];
                let sub = item.price * item.qty;
                total += sub;
                count += item.qty;
                
                tbody.append(`
                    <tr>
                        <td style="width: 45%; vertical-align: middle;">
                            <div class="fw-bold text-truncate" style="max-width: 150px;">${item.name}</div>
                            <div class="text-muted small">${item.price.toLocaleString()}</div>
                        </td>
                        <td style="width: 25%; vertical-align: middle;" class="text-center">
                            <div class="input-group input-group-sm flex-nowrap">
                                <button class="btn btn-outline-secondary px-1" onclick="updateQty(${id}, -1)">-</button>
                                <input type="number" class="form-control text-center px-0" value="${item.qty}" min="1" onchange="onQtyChange(${id}, this)" style="min-width: 40px;">
                                <button class="btn btn-outline-secondary px-1" onclick="updateQty(${id}, 1)">+</button>
                            </div>
                        </td>
                        <td style="width: 25%; vertical-align: middle;" class="text-end fw-bold text-dark">
                            ${sub.toLocaleString()}
                        </td>
                        <td style="width: 5%; vertical-align: middle;" class="text-end">
                            <i class="fas fa-times text-danger" style="cursor:pointer" onclick="removeFromCart(${id})"></i>
                        </td>
                    </tr>
                `);
            }
            $('#totalAmount').text(total.toLocaleString() + ' ₫');
            $('#totalItems').text(count);
        }

        $('#searchProduct').on('keyup', function() {
            let val = $(this).val().toLowerCase();
            $('.product-item').filter(function() {
                // Search by name and keep category filter in mind if needed, 
                // but usually search overrides category or works within it. 
                // Let's keep it simple: strict filter by name AND category logic
                let isMatch = $(this).data('name').toLowerCase().indexOf(val) > -1;
                // Check visible state? Or just reset logic. 
                // Better: re-evaluate both filters.
                return isMatch;
            }).show();
            
            // Hide non-matches
             $('.product-item').filter(function() {
                return $(this).data('name').toLowerCase().indexOf(val) === -1;
            }).hide();
            
            // Re-apply category if user wants combined filtering
            let cat = $('#categoryFilter').val();
            if(cat !== 'all') {
                 $('.product-item:visible').filter(function() {
                    return $(this).data('cat') != cat;
                 }).hide();
            }
        });

        $('#categoryFilter').on('change', function() {
             $('#searchProduct').trigger('keyup'); // Re-trigger filter chain
        });

        function checkout() {
            if ($.isEmptyObject(cart)) {
                Swal.fire('Giỏ hàng trống!', 'Vui lòng chọn sản phẩm.', 'warning');
                return;
            }

            let items = [];
            for(let id in cart) {
                items.push({ productId: parseInt(id), quantity: cart[id].qty });
            }
            
            // Optional: Confirm payment
            Swal.fire({
                title: 'Xác nhận thanh toán?',
                html: `Tổng tiền: <b>${$('#totalAmount').text()}</b>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Thanh toán',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    processPayment(items);
                }
            });
        }

        function processPayment(items) {
             let data = {
                customerId: $('#customerSelect').val() ? parseInt($('#customerSelect').val()) : null,
                items: items,
                paymentMethod: $('#paymentMethod').val() // Get selected payment method
            };
            
            // Show loading
            Swal.showLoading();

            $.ajax({
                url: '@Url.Action("CreateOrder", "Pos")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(res) {
                    Swal.close();
                    if(res.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công!',
                            text: 'Đơn hàng #' + res.orderId + ' đã được tạo.',
                            timer: 2000
                        });
                        cart = {};
                        renderCart();
                    } else {
                        Swal.fire('Lỗi!', res.message, 'error');
                    }
                },
                error: function() {
                    Swal.close();
                    Swal.fire('Lỗi hệ thống!', 'Không thể kết nối đến máy chủ.', 'error');
                }
            });
        }
        
        // Initial render
        renderCart();
    </script>
}
