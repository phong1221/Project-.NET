@page "/user/checkout"
@inject CartService CartService
@inject CustomerAuthService AuthService
@inject IOrderService OrderService
@inject NavigationManager Nav

<h2>Xác nhận Đặt hàng</h2>

<div class="row">
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header">Thông tin khách hàng</div>
            <div class="card-body">
                <p><strong>Họ tên:</strong> @AuthService.CurrentCustomer?.Name</p>
                <p><strong>SĐT:</strong> @AuthService.CurrentCustomer?.Phone</p>
                <p><strong>Địa chỉ:</strong> @AuthService.CurrentCustomer?.Address</p>
            </div>
        </div>
        
         <div class="card shadow mb-4">
            <div class="card-header">Thông tin hóa đơn</div>
            <div class="card-body">
                @foreach(var item in CartService.Items)
                {
                    <div class="d-flex justify-content-between">
                        <span>@item.Product.ProductName x @item.Quantity</span>
                        <span>@((item.Product.Price * item.Quantity).ToString("N0")) ₫</span>
                    </div>
                }
                <hr />
                
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Mã giảm giá" @bind="promoCode" />
                    <button class="btn btn-outline-secondary" type="button" @onclick="ApplyPromo">Áp dụng</button>
                </div>

                <div class="d-flex justify-content-between mb-2">
                    <span>Tạm tính:</span>
                    <span>@CartService.TotalAmount.ToString("N0") ₫</span>
                </div>
                
                @if (discountAmount > 0)
                {
                    <div class="d-flex justify-content-between mb-2 text-success">
                        <span>Giảm giá (@appliedPromo?.PromoCode):</span>
                        <span>-@discountAmount.ToString("N0") ₫</span>
                    </div>
                }

                <h5 class="d-flex justify-content-between mt-3 text-danger fw-bold">
                    <span>Tổng tiền:</span>
                    <span>@((CartService.TotalAmount - discountAmount).ToString("N0")) ₫</span>
                </h5>
            </div>
        </div>
        
        <div class="card shadow mb-4">
            <div class="card-header">Phương thức thanh toán</div>
            <div class="card-body">
                <div class="mb-3">
                    <label>Chọn phương thức:</label>
                    <select class="form-select" @bind="paymentMethod">
                        <option value="cod">Tiền mặt (COD)</option>
                        <option value="card">Thẻ (Card)</option>
                        <option value="e-wallet">Ví điện tử (E-Wallet)</option>
                        <option value="bank_transfer">Chuyển khoản (Bank Transfer)</option>
                    </select>
                </div>
            </div>
        </div>
        
        <button class="btn btn-success w-100" @onclick="PlaceOrder">Xác nhận đặt hàng</button>
    </div>
</div>

@inject IJSRuntime JSRuntime
@inject IPromotionService PromotionService

@code {
    string paymentMethod = "cod";
    string promoCode = "";
    Promotion? appliedPromo;
    decimal discountAmount = 0;

    async Task ApplyPromo()
    {
        if (string.IsNullOrWhiteSpace(promoCode)) return;

        var promo = await PromotionService.GetPromotionByCodeAsync(promoCode);
        if (promo == null || promo.Status != "active")
        {
             await JSRuntime.InvokeVoidAsync("ShowToast", "error", "Mã giảm giá không tồn tại hoặc đã hết hạn.");
             appliedPromo = null;
             discountAmount = 0;
             return;
        }

        var today = DateTime.Now.Date;
        if (promo.StartDate > today || promo.EndDate < today)
        {
             await JSRuntime.InvokeVoidAsync("ShowToast", "error", "Mã giảm giá chưa bắt đầu hoặc đã hết hạn.");
             appliedPromo = null;
             discountAmount = 0;
             return;
        }

        if (CartService.TotalAmount < promo.MinOrderAmount)
        {
             await JSRuntime.InvokeVoidAsync("ShowToast", "error", $"Đơn hàng tối thiểu phải từ {promo.MinOrderAmount:N0}₫.");
             appliedPromo = null;
             discountAmount = 0;
             return;
        }

        if (promo.UsageLimit > 0 && promo.UsedCount >= promo.UsageLimit)
        {
             await JSRuntime.InvokeVoidAsync("ShowToast", "error", "Mã giảm giá đã hết lượt sử dụng.");
             appliedPromo = null;
             discountAmount = 0;
             return;
        }

        // Apply Discount
        appliedPromo = promo;
        if (promo.DiscountType == "percent")
        {
            discountAmount = CartService.TotalAmount * (promo.DiscountValue / 100);
        }
        else
        {
            discountAmount = promo.DiscountValue;
        }
        
        // Cap at total amount (optional, but logical)
        if (discountAmount > CartService.TotalAmount) discountAmount = CartService.TotalAmount;

        await JSRuntime.InvokeVoidAsync("ShowToast", "success", "Áp dụng mã giảm giá thành công!");
    }

    async Task PlaceOrder()
    {
        if (!AuthService.IsLoggedIn) { Nav.NavigateTo("/user/login"); return; }
        
        try
        {
            // Pass userId as null, customerId, promoId, items list, selected payment method
            var itemsList = CartService.Items.Select(i => (i.Product.ProductId, i.Quantity)).ToList();
            
            // Create order with 'pending' status
            await OrderService.CreateOrderAsync(
                null, 
                AuthService.CurrentCustomer.CustomerId, 
                appliedPromo?.PromoId, 
                itemsList, 
                paymentMethod, 
                "pending"
            );
            
            await CartService.ClearCartAsync();
            Nav.NavigateTo("/user/order-success");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("ShowToast", "error", "Lỗi đặt hàng: " + ex.Message);
            // Log the full error to console if needed
            Console.WriteLine(ex.ToString());
        }
    }
}
