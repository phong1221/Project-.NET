@page "/user/product/{id:int}"
@inject IProductService ProductService
@inject CartService CartService
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav

@using StoreManagement.Data.Entities

<div class="container animate__animated animate__fadeIn mt-4">
    <button class="btn btn-outline-secondary mb-4" @onclick="GoBack"><i class="fas fa-arrow-left me-2"></i>Quay lại</button>

    @if (product == null)
    {
         @if (notFound)
         {
             <div class="alert alert-warning">Sản phẩm không tồn tại.</div>
         }
         else
         {
             <div class="text-center">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
         }
    }
    else
    {
        <div class="card shadow-lg border-0 rounded-3 overflow-hidden">
            <div class="row g-0">
                <div class="col-md-5 bg-light d-flex align-items-center justify-content-center" style="min-height: 400px;">
                    <i class="fas fa-box-open fa-6x text-muted opacity-50"></i>
                </div>
                <div class="col-md-7">
                    <div class="card-body p-5">
                        <small class="text-uppercase text-muted fw-bold">@product.Category?.CategoryName</small>
                        <h2 class="fw-bold my-3">@product.ProductName</h2>
                        
                        <div class="d-flex align-items-center mb-4">
                            <span class="text-warning me-2"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i></span>
                            <span class="text-muted small">(4.5 đánh giá)</span>
                        </div>

                        <h3 class="text-danger fw-bold mb-4">@product.Price.ToString("N0") ₫ / @product.Unit</h3>

                        <p class="text-muted mb-4">
                            Mô tả sản phẩm đang được cập nhật...
                            <br />
                            Barcode: @(product.Barcode ?? "N/A")
                            <br />
                            Nhà cung cấp: @(product.Supplier?.Name ?? "N/A")
                        </p>

                        <div class="d-flex align-items-center mb-4">
                             <div class="input-group" style="width: 140px;">
                                <button class="btn btn-outline-secondary" @onclick="DecreaseQty">-</button>
                                <input type="text" class="form-control text-center" value="@quantity" readonly />
                                <button class="btn btn-outline-secondary" @onclick="IncreaseQty">+</button>
                            </div>
                            <span class="ms-3 text-muted">Có sẵn: 100+</span>
                        </div>

                        <button class="btn btn-primary btn-lg px-5 py-3 rounded-pill shadow-sm fw-bold" @onclick="AddToCart">
                            <i class="fas fa-cart-plus me-2"></i>Thêm vào giỏ hàng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@inject CustomerAuthService AuthService

@code {
    [Parameter]
    public int Id { get; set; }

    private Product? product;
    private bool notFound = false;
    private int quantity = 1;

    protected override async Task OnInitializedAsync()
    {
        product = await ProductService.GetProductByIdAsync(Id);
        if (product == null) notFound = true;
    }

    void IncreaseQty() => quantity++;
    void DecreaseQty() { if (quantity > 1) quantity--; }

    async Task AddToCart()
    {
        if (!AuthService.IsLoggedIn)
        {
            await JSRuntime.InvokeVoidAsync("ShowToast", "error", "Vui lòng đăng nhập để mua hàng!");
            return;
        }

        if (product != null)
        {
            await CartService.AddToCartAsync(product, quantity);
            await JSRuntime.InvokeVoidAsync("ShowToast", "success", $"Đã thêm {quantity} {product.ProductName} vào giỏ");
        }
    }

    void GoBack()
    {
        Nav.NavigateTo("/user");
    }
}
